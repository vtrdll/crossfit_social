{% extends "base.html" %}
{% load static %}
{% block title %}FEED{% endblock %}

{% block content %}
<div class="container py-4">

  <!-- STORIES -->
  <div class="mb-4">
    <div class="d-flex overflow-auto" style="gap: 1rem;">
      {% for story in stories %}
        <div class="text-center">
          <div
            class="rounded-circle border border-3 border-primary"
            style="width:70px; height:70px; overflow:hidden; cursor:pointer;"
            data-bs-toggle="modal"
            data-bs-target="#storyModal{{ story.id }}"
          >
            {% if story.user.profile.photo %}
              <img
                src="{{ story.user.profile.photo.url }}"
                alt="Story de {{ story.user.username }}"
                class="w-100 h-100"
                style="object-fit:cover;"
              >
            {% else %}
              <div class="bg-secondary w-100 h-100"></div>
            {% endif %}
          </div>
          <small>{{ story.user.username }}</small>
        </div>

        <!-- Modal do Story (com carrossel de m√≠dias) -->
        <div class="modal fade" id="storyModal{{ story.id }}" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content bg-dark text-white">
              <div class="modal-header border-0">
                <h6 class="modal-title">{{ story.user.username }}</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
              </div>

              <div class="modal-body p-0">

                <div id="storyCarousel{{ story.id }}" class="carousel slide" data-bs-ride="false">
                  <div class="carousel-inner">

                    {% for media in story.media.all %}
                      <div class="carousel-item {% if forloop.first %}active{% endif %} d-flex align-items-center justify-content-center" style="min-height:60vh;">
                        {% if media.photo %}
                          <img
                            src="{{ media.photo.url }}"
                            class="img-fluid"
                            style="max-height: 90vh; object-fit: contain;"
                            alt="Story"
                          >
                        {% elif media.video %}
                          <video
                            controls
                            autoplay
                            class="d-block"
                            style="max-height: 90vh; max-width: 100%; object-fit: contain;"
                          >
                            <source src="{{ media.video.url }}" type="video/mp4">
                            Seu navegador n√£o suporta v√≠deo.
                          </video>
                        {% endif %}
                      </div>
                    {% empty %}
                      <div class="p-4 text-center">
                        <p class="text-muted mb-0">Nenhuma m√≠dia dispon√≠vel para este story.</p>
                      </div>
                    {% endfor %}

                  </div>

                  {% if story.media.all %}
                    <button class="carousel-control-prev" type="button" data-bs-target="#storyCarousel{{ story.id }}" data-bs-slide="prev">
                      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                      <span class="visually-hidden">Anterior</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#storyCarousel{{ story.id }}" data-bs-slide="next">
                      <span class="carousel-control-next-icon" aria-hidden="true"></span>
                      <span class="visually-hidden">Pr√≥ximo</span>
                    </button>
                  {% endif %}
                </div>

              </div>
            </div>
          </div>
        </div>
        <!-- Fim do Modal -->

      {% empty %}
        <p class="text-muted">Nenhum story dispon√≠vel.</p>
      {% endfor %}
    </div>
  </div>

  <h1 class="mb-4 text-center">üèãÔ∏è CROSS</h1>

  {% if request.path == '/user-list/' %}
    <h3 class="text-center">üë§ Usu√°rios encontrados</h3>

    {% if search_users %}
      {% for user in search_users %}
        <div class="card mb-3 shadow-sm">
          <div class="card-body d-flex align-items-center">
            {% if user.profile.photo %}
              <img
                src="{{ user.profile.photo.url }}"
                alt="Foto de {{ user.username }}"
                class="rounded-circle me-3"
                width="60"
                height="60"
                style="object-fit: cover;"
              >
            {% else %}
              <div class="rounded-circle bg-secondary me-3" style="width: 60px; height: 60px;"></div>
            {% endif %}

            <div>
              <a href="{% url 'profile-detail' user.pk %}" class="no-link-style">
                <h5 class="mb-0">
                  {{ user.username }}
                  <img src="{% static 'verified.png' %}" alt="Verificado" width="24">
                </h5>
              </a>
              <small class="text-muted">
                Entrou em {{ user.profile.created_at_profile|date:"d/m/Y" }}
                <img src="{% static 'schedule.png' %}" alt="Calendario" width="24">
              </small>
            </div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <p class="text-muted text-center">Nenhum usu√°rio encontrado para "{{ request.GET.search }}".</p>
    {% endif %}
  {% endif %}

  {% if pined_wod %}
    <!-- Card do treino fixado -->
    <div class="card shadow mb-4 border-success position-relative">
      <div class="position-absolute top-0 end-0 bg-success text-white px-3 py-1 rounded-start">üìå FIXADO</div>
      <div class="card-body">

        <!-- Autor -->
        <div class="d-flex align-items-center mb-3">
          {% if coach_profile.photo %}
            <img
              src="{{ coach_profile.photo.url }}"
              alt="{{ post_coach.post.author.username }}"
              class="rounded-circle me-3"
              width="50"
              height="50"
              style="object-fit: cover;"
            >
          {% else %}
            <div class="rounded-circle bg-secondary me-3" style="width:50px; height:50px;"></div>
          {% endif %}

          <div>
            <a href="{% url 'profile-detail' coach_profile.pk %}" class="no-link-style">
              <h6 class="mb-0 text-success">
                {{ coach_profile.user.username }}
                <img src="{% static 'verified.png' %}" alt="Verificado" width="20">
              </h6>
            </a>
            <small class="text-muted">Treino fixado do coach</small>
          </div>
        </div>

        <h4 class="card-title">{{ pined_wod.title }}</h4>
        <p class="card-text">{{ pined_wod.text }}</p>
        <p class="card-text">{{ pined_wod.warmup }}</p>

        <div>
          <small class="text-muted">{{ post_coach.post.created_at|date:"d/m/Y H:i" }}</small> ‚Äî
          <small class="text-muted">{{ post_coach.post.like.count }} Curtidas</small>
        </div>
      </div>
    </div>
  {% endif %}

  <!-- Feed de posts -->
  {% for post in posts %}
    <div class="card shadow-sm mb-4">
      <div class="card-body">

        <!-- Autor do post -->
        <div class="d-flex align-items-center mb-3">
          {% if post.author.profile.photo %}
            <img
              src="{{ post.author.profile.photo.url }}"
              alt="Foto de {{ post.author.username }}"
              class="rounded-circle me-3"
              width="50"
              height="50"
              style="object-fit: cover;"
            >
          {% else %}
            <div class="rounded-circle bg-secondary me-3" style="width:50px; height:50px;"></div>
          {% endif %}
          <div>
            <a href="{% url 'profile-detail' post.author.pk %}" class="no-link-style">
              <h6 class="mb-0">
                {{ post.author.username }}
                <img src="{% static 'verified.png' %}" alt="Verificado" width="24">
              </h6>
            </a>
          </div>
        </div>

        <h4 class="card-title">{{ post.titulo }}</h4>
        <p class="card-text">{{ post.text }}</p>

        <!-- Contagem de m√≠dias -->
        {% with imagens_count=post.media_dict.imagens|length|default:0 videos_count=post.media_dict.videos|length|default:0 %}
          {% with total_media=imagens_count|add:videos_count %}
            {% if total_media > 0 %}
              <p class="text-muted text-center">üì∑ {{ total_media }} m√≠dia(s)</p>
            {% endif %}

            {% if total_media > 1 %}
              <!-- Carrossel com controles -->
              <div style="max-width: 470px; margin: auto;">
                <div id="carouselPost{{ post.id }}" class="carousel slide" data-bs-ride="false">
                  <div class="carousel-inner">

                    {% for imagem in post.media_dict.imagens %}
                      <div class="carousel-item {% if forloop.first %}active{% endif %}">
                        <img
                          src="{{ imagem }}"
                          class="d-block w-100"
                          alt="Imagem do post"
                          style="max-height:900px; object-fit:cover; cursor:pointer;"
                          data-bs-toggle="modal"
                          data-bs-target="#mediaModal"
                          data-type="image"
                          data-src="{{ imagem }}"
                        >
                      </div>
                    {% endfor %}

                    {% for vid in post.media_dict.videos %}
                      <div class="carousel-item {% if forloop.first and not post.media_dict.imagens %}active{% endif %}">
                        <video
                          class="d-block w-100"
                          muted
                          autoplay
                          controls
                          preload="metadata"
                          style="max-height:900px; object-fit:cover; cursor:pointer;"
                          data-bs-toggle="modal"
                          data-bs-target="#mediaModal"
                          data-type="video"
                          data-src="{{ vid }}"
                          loop
                        >
                          <source src="{{ vid }}" type="video/mp4">
                          Seu navegador n√£o suporta v√≠deo.
                        </video>
                      </div>
                    {% endfor %}

                  </div>

                  <div class="d-flex justify-content-center gap-3 mt-3">
                    <button class="btn btn-primary btn-sm" type="button" data-bs-target="#carouselPost{{ post.id }}" data-bs-slide="prev">‚Üê Anterior</button>
                    <button class="btn btn-primary btn-sm" type="button" data-bs-target="#carouselPost{{ post.id }}" data-bs-slide="next">Pr√≥ximo ‚Üí</button>
                  </div>
                </div>
              </div>

            {% elif total_media == 1 %}
              <!-- Exibe a m√≠dia √∫nica sem carrossel -->
              <div class="d-flex justify-content-center">
                {% if imagens_count == 1 %}
                  <img
                    src="{{ post.media_dict.imagens.0 }}"
                    class="d-block"
                    style="max-height:900px; max-width:100%; object-fit:cover; cursor:pointer;"
                    data-bs-toggle="modal"
                    data-bs-target="#mediaModal"
                    data-type="image"
                    data-src="{{ post.media_dict.imagens.0 }}"
                  >
                {% elif videos_count == 1 %}
                  <video
                    class="d-block"
                    muted
                    autoplay
                    controls
                    preload="metadata"
                    style="max-height:900px; max-width:100%; object-fit:cover; cursor:pointer;"
                    data-bs-toggle="modal"
                    data-bs-target="#mediaModal"
                    data-type="video"
                    data-src="{{ post.media_dict.videos.0 }}"
                    loop
                  >
                    <source src="{{ post.media_dict.videos.0 }}" type="video/mp4">
                    Seu navegador n√£o suporta v√≠deo.
                  </video>
                {% endif %}
              </div>
            {% endif %}
          {% endwith %}
        {% endwith %}

        <!-- Data e curtidas -->
        <div>
          <a href="{% url 'post-detail' post.pk %}" class="no-link-style">
            <small class="text-muted">{{ post.created_at|date:"d/m/Y H:i" }}</small>
          </a> ‚Äî
          <small class="text-muted">{{ post.like.count }} Curtidas</small>
        </div>

        <!-- Curtir e comentar -->
        <div class="d-flex align-items-center gap-3 mt-3">
          <form method="post" action="{% url 'post-like' post.pk %}" class="m-0 p-0">
            {% csrf_token %}
            {% if user in post.like.all %}
              <button type="submit" class="btn btn-sm btn-outline-danger">‚ù§Ô∏è Descurtir</button>
            {% else %}
              <button type="submit" class="btn btn-sm btn-outline-success">ü§ç Curtir</button>
            {% endif %}
          </form>

          <form method="post" class="d-flex flex-grow-1 align-items-center m-0 p-0" style="gap:0.5rem;">
            {% csrf_token %}
            <textarea name="comment" rows="1" class="form-control" style="resize:none;" placeholder="Escreva um coment√°rio..."></textarea>
            <input type="hidden" name="post_id" value="{{ post.id }}">
            <button type="submit" class="btn btn-outline-primary btn-sm">Comentar</button>
          </form>
        </div>

        <!-- Bot√µes de editar/excluir post -->
        {% if post in user.post_set.all %}
          <div class="d-flex justify-content-end gap-2 mt-2">
            <a href="{% url 'post-edit' post.pk %}" class="btn btn-sm btn-outline-primary">Editar Post</a>
            <a href="{% url 'post-delete' post.pk %}" class="btn btn-sm btn-outline-danger">Excluir Post</a>
          </div>
        {% endif %}

        <!-- Coment√°rios -->
        <div class="mt-4">
          <h6 class="text-muted">üí¨ Coment√°rios</h6>

          {% for comment in post.comment_set.all %}
            <div class="d-flex align-items-start mb-2">
              {% if comment.author.profile.photo %}
                <img
                  src="{{ comment.author.profile.photo.url }}"
                  alt="{{ comment.author.username }}"
                  class="rounded-circle me-2"
                  width="32"
                  height="32"
                  style="object-fit: cover;"
                >
              {% endif %}

              <div class="bg-light rounded px-3 py-2">
                <strong>
                  {{ comment.author.username }}
                  <img src="{% static 'verified.png' %}" alt="Verificado" width="24">
                  :
                </strong>
                <span>{{ comment.comment }}</span>
              </div>

              <a class="ms-2"><small class="text-muted">{{ comment.like_comment.count }}</small> Curtidas</a>

              <form method="post" action="{% url 'like-comment' comment.pk %}" class="m-0 p-0 ms-2">
                {% csrf_token %}
                {% if user in comment.like_comment.all %}
                  <button type="submit" class="btn btn-sm btn-outline-danger">‚ù§Ô∏è Descurtir</button>
                {% else %}
                  <button type="submit" class="btn btn-sm btn-outline-success">ü§ç Curtir</button>
                {% endif %}
              </form>
            </div>

            {% if comment in user.comment_set.all %}
              <div class="d-flex justify-content-end gap-2 mt-2">
                <a href="{% url 'comment-update' comment.pk %}" class="btn btn-sm btn-outline-primary">Editar Coment√°rio</a>
                <a href="{% url 'comment-delete' comment.pk %}" class="btn btn-sm btn-outline-danger">Deletar Coment√°rio</a>
              </div>
            {% endif %}
          {% empty %}
            <p class="text-muted">Nenhum coment√°rio ainda.</p>
          {% endfor %}
        </div>

      </div>
    </div>
  {% empty %}
    <p class="text-center text-muted">Nenhum post encontrado.</p>
  {% endfor %}

</div>

<!-- Modal para mostrar m√≠dia dos posts -->
<div class="modal fade" id="mediaModal" tabindex="-1" aria-labelledby="mediaModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content bg-transparent border-0">
      <div class="modal-body p-0 position-relative">
        <button
          type="button"
          class="btn-close btn-close-white position-absolute top-0 end-0 m-3"
          data-bs-dismiss="modal"
          aria-label="Fechar"
        ></button>

        <img id="modalImage" src="" alt="Imagem ampliada" class="img-fluid w-100 d-none" />

        <video id="modalVideo" controls class="w-100 d-none">
          <source src="" type="video/mp4" />
          Seu navegador n√£o suporta v√≠deo.
        </video>
      </div>
    </div>
  </div>
</div>

<script>
  // Modal de m√≠dia dos posts
  const mediaModal = document.getElementById('mediaModal');
  const modalImage = document.getElementById('modalImage');
  const modalVideo = document.getElementById('modalVideo');

  mediaModal.addEventListener('show.bs.modal', function (event) {
    const triggerElement = event.relatedTarget;
    const type = triggerElement.getAttribute('data-type');
    const src = triggerElement.getAttribute('data-src');

    if (type === 'image') {
      modalImage.src = src;
      modalImage.classList.remove('d-none');
      modalVideo.classList.add('d-none');
      modalVideo.pause();
      modalVideo.removeAttribute('src');
      modalVideo.load();
    } else if (type === 'video') {
      modalVideo.src = src;
      modalVideo.classList.remove('d-none');
      modalImage.classList.add('d-none');
      modalVideo.load();
    }
  });

  mediaModal.addEventListener('hidden.bs.modal', function () {
    modalImage.src = '';
    modalVideo.pause();
    modalVideo.src = '';
  });
</script>
{% endblock %}
